# Руководство по работе с миграциями

Этот документ описывает, как работать с миграциями базы данных в проекте Coffee Team Management.

## Быстрый старт

### Применить все миграции
```bash
make db-upgrade
```

### Создать новую миграцию
```bash
make db-migrate
```

### Показать справку по всем командам
```bash
make help
```

## Команды для работы с базой данных

### Основные команды

| Команда | Описание |
|---------|----------|
| `make db-upgrade` | Применить все миграции |
| `make db-migrate` | Создать новую миграцию |
| `make db-downgrade` | Откатить последнюю миграцию |
| `make db-current` | Показать текущую версию схемы |
| `make db-history` | Показать историю миграций |

### Дополнительные команды

| Команда | Описание |
|---------|----------|
| `make db-reset` | ⚠️ Сбросить базу данных (удаляет все данные!) |
| `make db-stamp` | Отметить базу как находящуюся на определенной ревизии |
| `make db-migrate-all` | Автоматически применить все миграции |

## Типичные сценарии использования

### 1. Настройка проекта с нуля
```bash
# Установить зависимости
make install-dev

# Применить все миграции
make db-upgrade

# Или использовать комбинированную команду
make dev-setup
```

### 2. Создание новой миграции
```bash
# После изменения моделей
make db-migrate
# Введите название миграции когда будет запрос

# Применить созданную миграцию
make db-upgrade
```

### 3. Откат изменений
```bash
# Откатить последнюю миграцию
make db-downgrade

# Сбросить базу данных полностью
make db-reset
```

### 4. Проверка статуса миграций
```bash
# Текущая версия
make db-current

# История всех миграций
make db-history
```

## Структура миграций

Миграции находятся в папке `src/alembic/versions/`. Каждая миграция имеет:

- **Уникальный ID** (хеш)
- **Название** (slug)
- **Зависимость** от предыдущей миграции
- **Функции upgrade() и downgrade()**

### Текущие миграции

1. `a8e1a0e84b13_first_migration.py` - Создание базовых таблиц
2. `269aa9fa4561_add_manager_to_cafe.py` - Добавление manager_id в cafes
3. `f0d3ec0c10b3_add_cafe_fields_and_user_is_active.py` - Добавление полей name, city, is_active



## Команды разработки

### Полная настройка среды разработки
```bash
make dev-setup
```

### Полный сброс среды разработки
```bash
make dev-reset
```

### Линтинг и форматирование
```bash
make lint    # Проверка кода
make format  # Форматирование кода
```

## Docker команды

| Команда | Описание |
|---------|----------|
| `make docker-build` | Собрать Docker образы |
| `make docker-up` | Запустить контейнеры |
| `make docker-down` | Остановить контейнеры |
| `make docker-logs` | Показать логи |

## Troubleshooting

### Проблема: "Migration head not found"
```bash
# Проверить текущий статус
make db-current

# Если база пуста, применить все миграции
make db-upgrade
```

### Проблема: Конфликт миграций
```bash
# Сбросить базу и применить миграции заново
make db-reset
```

### Проблема: Ошибка в миграции
```bash
# Откатить проблемную миграцию
make db-downgrade

# Исправить код миграции или модели
# Создать новую миграцию
make db-migrate
```